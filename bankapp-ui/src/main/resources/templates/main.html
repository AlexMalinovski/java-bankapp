<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta http-equiv='Content-Type' content='text/html; charset=UTF-8'/>
    <title>Корзина товаров</title>
    <script language="JavaScript">
        setInterval(() => {
            var td = document.getElementById('exchange_rates');
            fetch('/api/rates')
                .then(response => response.json())
                .then(json => {
                    var table = '<table style="width:100%;margin-left:auto;margin-right:auto;border-radius:2%;padding:10px;background-color:whitesmoke;">';
                    table += '<tr><th colspan="3">Курсы валют по отношению к рублю</th></tr>';
                    table += '<tr><th>Валюта</th><th>Обозначение</th><th>Курс</th></tr>';
                    json.forEach(rate => {
                        table += '<tr>';
                        table += '<td>' + rate.title + '</td>';
                        table += '<td>' + rate.name + '</td>';
                        table += '<td>' + rate.value + '</td>';
                        table += '</tr>';
                    });
                    table += '</table>';
                    td.innerHTML = table;
                })
                .catch(error => td.innerHTML = 'Ошибка при получении данных курсов валют');
        }, 1000);
    </script>
</head>

<body>
<a href="/logout" style="float:right;">
    <b>ВЫЙТИ &cudarrr;</b>
</a>
<table style="width:70%;margin-left:auto;margin-right:auto;">
    <tr>
        <td style="padding:2px;">
        <form method="post" th:action="${'/user/'+login+'/editPassword'}" th:object="${passwordChangeDto}" enctype="multipart/form-data">
        <table style="width:100%;margin-left:auto;margin-right:auto;border-radius:2%;padding:10px;background-color:whitesmoke;">
            <tr>
                <td style="font-weight:bold;">Логин</td>
                <td colspan="2" th:text="${login}"/>
            </tr>
            <tr>
                <td style="font-weight:bold;">Изменить пароль</td>
                <td>
                    <p>
                        Пароль: <input name="password" type="password" th:field="*{passwordNew}" required/>
                    </p>
                    <p>
                        Повторите пароль: <input name="confirm_password" type="password" th:field="*{passwordConfirm}" required/>
                    </p>
                    <p class="validationError" th:if="${#fields.hasErrors('passwordNew')}" th:errors="*{passwordNew}"></p>
                    <p class="validationError" th:if="${#fields.hasErrors('passwordEq')}" th:errors="*{passwordEq}"></p>
                    <p th:if="${passChangeResult.success() == false}" style="color:red;" th:text="${passChangeResult.error()}"></p>
                </td>
                <td style="text-align:right">
                    <button>Изменить пароль</button>
                </td>
            </tr>
        </table>
        </form>
        </td>
    </tr>
    <tr><td style="padding:2px;">
        <form method="post" th:object="${userAccountsDto}" th:action="${'/user/'+login+'/editUserAccounts'}" enctype="multipart/form-data">
        <table style="width:100%;margin-left:auto;margin-right:auto;border-radius:2%;padding:10px;background-color:whitesmoke;">
            <tr th:if="${userAccountsErrors!=null}" th:each="userAccountsError : ${userAccountsErrors}">
                <td style="color:red;" th:text="${userAccountsError}"/>
            </tr>
            <tr>
                <td style="font-weight:bold;">Фамилия Имя</td>
                <td th:text="${name}"/>
                <td>
                    <input name="name" type="text" th:field="*{name}" style="width:100%"/>
                    <p class="validationError" th:if="${#fields.hasErrors('name')}" th:errors="*{name}"></p>
                </td>
            </tr>
            <tr>
                <td style="font-weight:bold;">Дата рождения</td>
                <td th:text="${birthdate}"/>
                <td>
                    <input name="birthdate" type="date" th:value="*{birthdate}" style="width:100%"/>
                    <p class="validationError" th:if="${#fields.hasErrors('birthdate')}" th:errors="*{birthdate}"></p>
                </td>
            </tr>
            <tr th:each="account, itemStat : *{accounts}">
               <input type="hidden" th:field="*{accounts[__${itemStat.index}__].id}"/>
               <input type="hidden" th:field="*{accounts[__${itemStat.index}__].userLogin}"/>

                <input type="hidden" th:field="*{accounts[__${itemStat.index}__].currency}" />
                <input type="hidden" th:field="*{accounts[__${itemStat.index}__].value}" />




                <td style="font-weight:bold;" th:text="${account.getCurrency().getTitle()}" th:value="${account.currency}" th:field="${userAccountsDto.accounts}"></td>
                <td th:text="${account.getExists() ? (account.getValue()+' '+account.getCurrency().name()) : ''}" th:value="${account.value}"/>
                <td style="text-align:right">
<!--                    <input name="account" type="checkbox" th:checked="${account.getExists()}" th:value="${account.exists}"/>-->
                        <input type="checkbox" th:checked="${account.getExists()}" th:field="*{accounts[__${itemStat.index}__].exists}"/>
                </td>
            </tr>
            <tr>
                <td colspan="3" style="color:red">
                    <p th:if="${accChangeResult != null && accChangeResult.success() == false}" style="color:red;" th:text="${accChangeResult.error()}"></p>
                </td>
            </tr>
            <tr>
                <td style="text-align:right" colspan="3">
                    <button>Сохранить изменения</button>
                </td>
            </tr>
        </table>
        </form>
    </td></tr>
    <tr><td style="padding:2px;">
        <form method="post" th:action="${'/user/'+login+'/cash'}" th:object="${cashOperationDto}">
            <table style="width:100%;margin-left:auto;margin-right:auto;border-radius:2%;padding:10px;background-color:whitesmoke;">
                <tr th:if="${cashErrors!=null}" th:each="cashError : ${cashErrors}">
                    <td style="color:red;" th:text="${cashError}"/>
                </tr>
                <tr>
                    <td style="font-weight:bold;">Наличные</td>
                    <td>
                        Валюта
                        <select name="currency">
                            <option th:each="eachCurrency : ${currencies}" th:value="${eachCurrency.name()}" th:text="${eachCurrency.getTitle()}"/>
                        </select>
                    </td>
                    <td>
                        <input name="value" type="number" th:value="*{value}" style="width:100%" required/>
                    </td>
                    <td>
                    <td style="text-align:right">
                        <button name="action" value="PUT">Положить</button>
                        <button name="action" value="GET">Снять</button>
                    </td>
                </tr>
                <tr>
                    <td colspan="5">
                        <p class="validationError" th:if="${#fields.hasErrors('value')}" th:errors="*{value}"></p>
                        <p class="validationError" th:if="${cashOperationResult.success==false}" th:text="${cashOperationResult.error}"></p>
                    </td>
                </tr>
            </table>
        </form>
    </td></tr>
    <tr><td style="padding:2px;">
        <form method="post" th:action="${'/user/'+login+'/transfer'}" th:object="${moneyTransferDto}">
            <table style="width:100%;margin-left:auto;margin-right:auto;border-radius:2%;padding:10px;background-color:whitesmoke;">
                <tr th:if="${transferErrors!=null}" th:each="transferError : ${transferErrors}">
                    <td style="color:red;" th:text="${transferError}"/>
                </tr>
                <tr>
                    <td style="font-weight:bold;">Перевод себе</td>
                    <td>
                        Со счета
                        <select name="currencyFrom">
                            <option th:each="eachCurrency : ${currencies}" th:value="${eachCurrency.name()}" th:text="${eachCurrency.getTitle()}"/>
                        </select>
                    </td>
                    <td>
                        На счет
                        <select name="currencyTo">
                            <option th:each="eachCurrency : ${currencies}" th:value="${eachCurrency.name()}" th:text="${eachCurrency.getTitle()}"/>
                        </select>
                    </td>
                    <td>
                        <input name="value" type="number" th:value="${value}" style="width:100%" required/>
                    </td>
                    <td style="text-align:right">
                        <input hidden name="loginTo" th:value="${login}"/>
                        <button>Перевести</button>
                    </td>
                </tr>
                <tr th:if="${login} == ${moneyTransferDto.getLoginTo()}">
                    <td colspan="5">
                        <p class="validationError" th:if="${#fields.hasErrors('value')}" th:errors="*{value}"></p>
                        <p class="validationError" th:if="${moneyTransferResult.success==false}" th:text="${moneyTransferResult.error}"></p>
                    </td>
                </tr>
            </table>
        </form>
    </td></tr>
    <tr><td style="padding:2px;">
        <form method="post" th:action="${'/user/'+login+'/transfer'}" th:object="${moneyTransferDto}">
            <table style="width:100%;margin-left:auto;margin-right:auto;border-radius:2%;padding:10px;background-color:whitesmoke;">
                <tr>
                    <td style="font-weight:bold;">Перевод другому</td>
                    <td>
                        Со счета
                        <select name="currencyFrom">
                            <option th:each="eachCurrency : ${currencies}" th:value="${eachCurrency.name()}" th:text="${eachCurrency.getTitle()}"/>
                        </select>
                    </td>
                    <td>
                        На счет
                        <select name="currencyTo">
                            <option th:each="eachCurrency : ${currencies}" th:value="${eachCurrency.name()}" th:text="${eachCurrency.getTitle()}"/>
                        </select>
                    </td>
                    <td>
                        <input name="value" type="number" th:value="${value}"  required/>
                    </td>
                    <td>
                        Кому
                        <select name="loginTo">
                            <option th:each="user : ${users}" th:value="${user.getLogin()}" th:text="${user.getName()}"/>
                        </select>
                    </td>
                    <td style="text-align:right">
                        <button>Перевести</button>
                    </td>
                </tr>
                <tr th:if="${login} != ${moneyTransferDto.getLoginTo()}">
                    <td colspan="6">
                        <p class="validationError" th:if="${#fields.hasErrors('value')}" th:errors="*{value}"></p>
                        <p class="validationError" th:if="${moneyTransferResult.success==false}" th:text="${moneyTransferResult.error}"></p>
                    </td>
                </tr>
            </table>
        </form>
    </td></tr>

    <tr><td style="padding:2px;" id="exchange_rates">
    </td></tr>
</table>
</body>

</html>